local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AntiTeleportUI"
ScreenGui.ResetOnSpawn = false

local ToggleButton = Instance.new("ImageButton")
ToggleButton.Name = "CatToggle"
ToggleButton.Size = UDim2.new(0, 64, 0, 64)
ToggleButton.Position = UDim2.new(0, 20, 0, 20)
ToggleButton.BackgroundTransparency = 1
ToggleButton.Image = "rbxassetid://9416429537"

local ToggleLabel = Instance.new("TextLabel")
ToggleLabel.Name = "ToggleLabel"
ToggleLabel.Size = UDim2.new(0, 64, 0, 20)
ToggleLabel.Position = UDim2.new(0, 0, 1, 0)
ToggleLabel.BackgroundTransparency = 1
ToggleLabel.Text = "Anti-Teleport: ON"
ToggleLabel.TextColor3 = Color3.new(1, 1, 1)
ToggleLabel.TextStrokeTransparency = 0.5
ToggleLabel.Font = Enum.Font.SourceSansBold
ToggleLabel.TextSize = 14
ToggleLabel.Parent = ToggleButton

ToggleButton.Parent = ScreenGui
ScreenGui.Parent = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")

local antiTeleportActive = true
local antiAllTeleport = false
local lastSafeCFrame = nil
local lastHealth = nil
local humanoid = nil
local rootPart = nil

local function setToggleState(on)
    if on then
        ToggleButton.ImageColor3 = Color3.new(1, 1, 1)
        ToggleLabel.Text = "Anti-Teleport: ON"
    else
        ToggleButton.ImageColor3 = Color3.fromRGB(120,120,120)
        ToggleLabel.Text = "Anti-Teleport: OFF"
    end
end

local function setupCharacter(character)
    humanoid = character:FindFirstChildOfClass("Humanoid")
    rootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoid and rootPart then
        lastSafeCFrame = rootPart.CFrame
        lastHealth = humanoid.Health

        humanoid.HealthChanged:Connect(function(newHealth)
            if newHealth < lastHealth then
                antiTeleportActive = false
                antiAllTeleport = true
                setToggleState(false)
                ToggleLabel.Text = "Anti-Teleport: LOCKED"
            end
            lastHealth = newHealth
        end)
    end
end

LocalPlayer.CharacterAdded:Connect(setupCharacter)
if LocalPlayer.Character then
    setupCharacter(LocalPlayer.Character)
end


RunService.RenderStepped:Connect(function()
    if not humanoid or not rootPart then return end
    if antiTeleportActive or antiAllTeleport then
        local currentCFrame = rootPart.CFrame
        if lastSafeCFrame then
            local dist = (currentCFrame.Position - lastSafeCFrame.Position).Magnitude
            if dist > 10 then -- Teleport threshold (studs)
                if antiTeleportActive or antiAllTeleport then
                    rootPart.CFrame = lastSafeCFrame
                end
            else
                lastSafeCFrame = currentCFrame
            end
        else
            lastSafeCFrame = currentCFrame
        end
    end
end)

ToggleButton.MouseButton1Click:Connect(function()
    if antiAllTeleport then return end -- Can't toggle if locked
    antiTeleportActive = not antiTeleportActive
    setToggleState(antiTeleportActive)
end)

setToggleState(antiTeleportActive)

